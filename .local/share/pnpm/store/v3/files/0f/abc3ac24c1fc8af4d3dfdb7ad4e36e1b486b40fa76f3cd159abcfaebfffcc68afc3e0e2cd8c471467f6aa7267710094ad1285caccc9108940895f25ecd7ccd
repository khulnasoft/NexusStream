import e,{resolve as n,dirname as t,basename as r,join as o}from"node:path";import u from"fs-extra";import i from"json5";import{globby as s}from"globby";import{existsSync as c}from"node:fs";import{patchRefs as l}from"depseek";function a(){return a=Object.assign?Object.assign.bind():function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e},a.apply(this,arguments)}var f=function(e){var n=e.contents;return a({},e,{contents:0===n.trim().length?"\nexport {}\nexport default undefined\n":n})},d=function(e){return a({},e,{contents:e.contents.replace(/__dirname/g,"`${process.platform === 'win32' ? '' : '/'}${/file:\\/{2,3}(.+)\\/[^/]/.exec(import.meta.url)"+(e.isSource?"!":"")+"[1]}`")})},m=function(e){return a({},e,{contents:e.contents.replace(/__filename/g,"`${process.platform === 'win32' ? '' : '/'}${/file:\\/{2,3}(.+)/.exec(import.meta.url)"+(e.isSource?"!":"")+"[1]}`")})},p=function(e){return u.readFileSync(e,{encoding:"utf8"})},v=function(e,n){return u.outputFileSync(e,n,{encoding:"utf8"})},g=function(e){return i.parse(p(e))},h=function(e){return e?Array.isArray(e)?e:[e]:[]},b=u.unlinkSync,y=function(e){return e.replace(/\\/g,"/")},j=function e(r){var o=g(r);if(o.extends){var u=e(n(t(r),o.extends));return a({},u,o,{compilerOptions:a({},u.compilerOptions,o.compilerOptions)})}return o},P=function(e){var n=e.filename,t=e.filenames,r=e.options.cwd,o=e.ignore;return a({},e,{contents:l(e.contents,function(e){var u=e.endsWith("/")?e.slice(0,-1):e;return!u.includes("/")&&"."!==u&&".."!==u||o.includes(u)?e:x(n,u,t,r)})})},x=function(e,r,o,u){var i=t(e),s=n(u,"node_modules"),c=/^\..+\.[^./\\]+$/.test(r)?[r,r.replace(/\.[^./\\]+$/,"")]:[r],l=[".js",".cjs",".mjs"].reduce(function(e,n){return c.forEach(function(t){return e.push(""+t+n,t+"/index"+n)}),e},[]);return l.find(function(e){return o.includes(y(n(i,e)))})||l.find(function(e){return o.includes(y(n(s,e)))})||r},w=function(e){var n=e.contents,t=e.originName,o=e.filename;return a({},e,{contents:t===o?n:n.replace("//# sourceMappingURL="+r(t)+".map","//# sourceMappingURL="+r(o)+".map")})},M=function(e){var n=e.contents;return a({},e,{contents:n.includes("export default")?n:n+"\nexport default undefined\n"})},O=function(e){var n=e.options,t=e;return n.ext&&(t=P(t)),n.dirnameVar&&(t=d(t)),n.filenameVar&&(t=m(t)),n.fillBlank&&(t=f(t)),n.forceDefaultExport&&(t=M(t)),n.sourceMap&&(t=w(t)),t},_=function(e,t){return h(e).reduce(function(e,r){var o,u,i=j(n(t,r)),s=null==i||null==(o=i.compilerOptions)?void 0:o.outDir,c=null==i||null==(u=i.compilerOptions)||null==u.module.toLowerCase?void 0:u.module.toLowerCase();return s&&c.startsWith("es")?e.push(s):console.warn("tsconfig should declare `outDir` and `module` type es6 or above"),e},[])},S=function(e,n){if(!n)return e;var t=n;return t.includes("*")&&(t=t.slice(0,t.indexOf("*"))).includes("/")&&(t=t.slice(0,t.lastIndexOf("/"))),o(e,t)},k={cwd:process.cwd(),tsconfig:"./tsconfig.json",filenameVar:!0,dirnameVar:!0,ext:!0,unlink:!0,debug:function(){}},$=function(e,n){return e.map(function(e){return e.endsWith(".d.ts")?e:e.replace(/\.[^./\\]+$/,n)})},F=function(e){try{var n=function(e){return a({},k,e,{debug:"function"==typeof(null==e?void 0:e.debug)?e.debug:!0===(null==e?void 0:e.debug)?console.log:k.debug})}(e);return Promise.resolve(N(n)).then(function(e){return Promise.resolve(D(e,n)).then(function(){})})}catch(e){return Promise.reject(e)}},N=function(n){try{var r=n.cwd,u=n.target,i=n.src,c=n.tsconfig,l=n.out,a=n.ext,f=n.debug,d=e.resolve(r,void 0===l?r:l),m=h(i),p=[].concat(h(u),_(c,r));f("debug:cwd",r),f("debug:outdir",d),f("debug:sources",m),f("debug:targets",p);var v=m.length>0;return Promise.resolve(function(e,n,t){return s(function(e,n){return e.length>0?e.map(function(e){return e.includes("*")?e:e+"/**/*.{ts,tsx}"}):n.map(function(e){return e.includes("*")?e:e+"/**/*.{js,d.ts}"})}(e,n),{cwd:t,onlyFiles:!0,absolute:!0})}(m,p,r)).then(function(e){return Promise.resolve(function(e){try{return Promise.resolve(function(e){return s(["node_modules/*/package.json","node_modules/@*/*/package.json"],{cwd:e,onlyFiles:!0,absolute:!0}).then(function(e){try{return Promise.resolve(Promise.all(e.map(function(e){try{return Promise.resolve(g(e)).then(function(n){var r=n.name,u=n.exports;if(!u)return{name:r};var i=t(e),c=function(e){var n=Object.entries(e),t=function e(n){return"string"==typeof n?[n]:Object.values(n).map(e).flat(2)};return"string"!=typeof e&&Object.keys(e).some(function(e){return e.startsWith(".")})?n.map(function(e){return[e[0],t(e[1])]}):[[".",t(e)]]}(u);return Promise.resolve(Promise.all(c.map(function(e){var n=e[0];return Promise.all(e[1].map(function(e){try{return Promise.resolve(s(e,{cwd:i,onlyFiles:!0,absolute:!1})).then(function(t){return t.map(function(t){return o(t).replace(S(".",e),S(r,n))})})}catch(e){return Promise.reject(e)}}))}))).then(function(e){return{name:r,files:e.flat(2)}})})}catch(e){return Promise.reject(e)}}))).then(function(e){return e.reduce(function(e,n){var t,r=n.name,o=n.files;return r&&e.names.push(r),o&&(t=e.files).push.apply(t,o),e},{names:[],files:[]})})}catch(e){return Promise.reject(e)}})}(e)).then(function(n){var t=n.names,r=n.files;return Promise.resolve(s(["!node_modules/.cache","!node_modules/.bin","!node_modules/**/node_modules"].concat(t.map(function(e){return"!node_modules/"+e}),["node_modules/**/*.(m|c)?js"]),{cwd:e,onlyFiles:!0,absolute:!0})).then(function(e){return{cjsModules:e,esmModules:r,allPackages:t}})})}catch(e){return Promise.reject(e)}}(r)).then(function(n){var t=n.cjsModules,r=n.esmModules,o=n.allPackages;f("debug:external-cjs-modules",t),f("debug:external-esm-modules",r);var u=[].concat(r,o),i="string"==typeof a?$(e,a):e,s=[].concat(t,i),c=[].concat(t,$(e,".js"));return f("debug:local-modules",i),{outDir:d,isSource:v,ignore:u,allJsModules:c,allModules:s,_localModules:i,localModules:e}})})}catch(e){return Promise.reject(e)}},D=function(e,n){try{var t=n.cwd,r=n.unlink,o=n.sourceMap,u=e.outDir,i=e.isSource,s=e.ignore,c=e.allJsModules,l=e.allModules,a=e.localModules;return Promise.resolve(Promise.all(e._localModules.map(function(e,f){try{var d=e.endsWith(".d.ts")?c:l,m=a[f],g=(i?m:e).replace(y(t),y(u)),h=p(m),j=O({options:n,contents:h,isSource:i,ignore:s,filename:e,filenames:d,originName:m,nextName:g});return v(g,j.contents),!i&&r&&t===u&&g!==m&&b(m),o&&W(m,g,r&&t===u),Promise.resolve()}catch(e){return Promise.reject(e)}}))).then(function(){})}catch(e){return Promise.reject(e)}},W=function(n,t,r){if(void 0===r&&(r=!1),n!==t){var o=n+".map";if(c(o)){var u=t+".map",i=g(o);i.file=e.basename(t),v(u,JSON.stringify(i)),r&&b(o)}}},L=function(e,n,t,r,o){return P({contents:e,filename:n,filenames:t,options:{cwd:r},ignore:o}).contents},V=function(e,n){return d({contents:e,isSource:n}).contents},J=function(e,n){return m({contents:e,isSource:n}).contents},A=function(e){return M({contents:e}).contents},C=function(e){return f({contents:e}).contents},E=function(e,n,t){return w({contents:e,originName:n,filename:t}).contents},R=function(e,n,t,r,o,u,i){return void 0===o&&(o=n),void 0===u&&(u=!1),void 0===i&&(i=[]),O({contents:e,filename:n,filenames:t,options:r,originName:o,isSource:u,ignore:i}).contents};export{k as DEFAULT_FIX_OPTIONS,F as fix,C as fixBlankFiles,R as fixContents,A as fixDefaultExport,V as fixDirnameVar,$ as fixFilenameExtensions,J as fixFilenameVar,L as fixModuleReferences,E as fixSourceMapRef};
//# sourceMappingURL=tsc-esm-fix.mjs.map
